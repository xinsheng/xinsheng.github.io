{% assign issues_repo = site.issues_repo %}
{% assign issue_id = include.issue_id %}
<hr>
<section id="comments">
  <div class="comment-actions">
    <h3>Comments <span id="comments-count"></span></h3>
    <h4><a href="https://github.com/{{ issues_repo }}/issues/{{ issue_id }}"><b>Post comment</b></a></h4>
  </div>
  <div id="comments-wrapper">
    Loading...
  </div>
</section>

<script>
  const commentsSection = document.getElementById('comments');
  const commentsWrapper = commentsSection.querySelector('#comments-wrapper');
  const commentsCount = commentsSection.querySelector('#comments-count');
const fetchComments = async () => {
  try {
    const comments = await (await fetch(
      'https://api.github.com/repos/{{ issues_repo }}/issues/{{ issue_id }}/comments'
    )).json();
    initRenderComments(comments);
  } catch (e) {
    commentsWrapper.innerHTML = `<p>Unable to retrieve the comments for this post.</p>`;
  }
}

const initRenderComments = async (comments) => {
  if (!comments.length) {
    commentsWrapper.innerHTML = `<p>No comments yet -_- Be the first to post!</p>`;
    return;
  }
  renderComments(comments);
}

const renderComments = (comments) => {
  commentsCount.innerText = `(${comments.length})`;

  const commentsList = document.createElement('ol');
  commentsList.className = 'comments-list';
  commentsList.setAttribute('aria-label', 'Comments on this blog post');

  commentsList.innerHTML = comments
  .sort((comment1, comment2) => {
    return comment1.created_at < comment2.created_at ? 1 : -1;
  })
  .map(comment => {
    const user = comment.user;
    const body = comment.body;
    const postedByAuthor = comment.author_association === 'OWNER';
    const edited = comment.created_at !== comment.updated_at;

    return `<li class="comment">
                <div class="commenter">
                    <img src="${user.avatar_url}" alt="" aria-hidden="true" width='30'/>
                    <a
                        href="https://github.com/${user.login}"
                        class="meta username"
                        >${user.login}</a
                    >${postedByAuthor ? '&nbsp;&nbsp;<span>Author</span>' : ''}
                </div>
                <div class="highlight"><pre>${body}</pre></div>
            </li>`;
  })
  .join('');
  commentsWrapper.innerHTML = '';
  commentsWrapper.appendChild(commentsList);
}
fetchComments();
</script>